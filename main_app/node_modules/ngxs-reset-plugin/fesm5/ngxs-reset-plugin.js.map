{"version":3,"file":"ngxs-reset-plugin.js","sources":["ng://ngxs-reset-plugin/lib/internals.ts","ng://ngxs-reset-plugin/lib/reset.service.ts","ng://ngxs-reset-plugin/lib/reset.handler.ts","ng://ngxs-reset-plugin/lib/symbols.ts","ng://ngxs-reset-plugin/lib/reset.plugin.ts","ng://ngxs-reset-plugin/lib/reset.module.ts"],"sourcesContent":["export interface MetaDataModel {\n  name: string | null;\n  defaults: any;\n  path: string | null;\n  children?: StateClass[];\n}\n\n/**\n * a simplified implementation of NGXS StateClass interface\n */\nexport interface StateClass<T = {}> {\n  NGXS_META?: MetaDataModel;\n\n  new (...args: any[]): T;\n}\n\nexport function noop() {\n  return () => {};\n}\n","import { Injectable } from '@angular/core';\n\n@Injectable()\nexport class ResetService {\n  initialState: any;\n}\n","import { Injectable } from '@angular/core';\nimport { Actions, InitState, ofActionSuccessful, Store, UpdateState } from '@ngxs/store';\nimport { take } from 'rxjs/operators';\nimport { ResetService } from './reset.service';\n\n@Injectable()\nexport class ResetHandler {\n  constructor(\n    private actions$: Actions,\n    private store: Store,\n    private resetService: ResetService,\n  ) {\n    this.actions$\n      .pipe(\n        ofActionSuccessful(InitState),\n        take(1),\n      )\n      .subscribe(() => (this.resetService.initialState = this.store.snapshot()));\n\n    this.actions$.pipe(ofActionSuccessful(UpdateState)).subscribe(\n      ({ addedStates }) =>\n        (this.resetService.initialState = {\n          ...this.resetService.initialState,\n          ...addedStates,\n        }),\n    );\n  }\n}\n","import { isDevMode } from '@angular/core';\nimport { getStoreMetadata } from '@ngxs/store';\nimport { MetaDataModel, StateClass } from './internals';\n\nexport type OverwriteTuple = [StateClass, any];\ntype MetaTuple = [MetaDataModel[], any[]];\ntype MetaListReducer = (\n  acc: MetaDataModel[],\n  state: StateClass,\n) => MetaDataModel[];\ntype MetaTupleReducer = (\n  acc: MetaTuple,\n  [state, value]: OverwriteTuple,\n) => MetaTuple;\n\n/**\n * Action to clear all state except given state(s)\n */\nexport class StateClear {\n  static readonly type = '@@CLEAR_STATE';\n  public readonly statesToKeep: MetaDataModel[];\n\n  // The duplication is necessary for TypeScript\n  // tslint:disable-next-line:unified-signatures\n  constructor(...statesToKeep: StateClass[]);\n  constructor();\n  constructor(...statesToKeep: StateClass[]) {\n    const reducer = createMetaDataListReducer(isDevMode());\n    this.statesToKeep = statesToKeep.reduce<MetaDataModel[]>(reducer, []);\n  }\n}\n\n/**\n * Action to reset given state(s) to defaults\n */\nexport class StateReset {\n  static readonly type = '@@RESET_STATE';\n  public readonly statesToReset: MetaDataModel[];\n  constructor(...statesToReset: StateClass[]) {\n    const reducer = createMetaDataListReducer(isDevMode());\n    this.statesToReset = statesToReset.reduce<MetaDataModel[]>(reducer, []);\n  }\n}\n\n/**\n * Action to reset all states expect given state(s) to defaults\n */\nexport class StateResetAll {\n  static readonly type = '@@RESET_STATE_ALL';\n  public readonly statesToKeep: MetaDataModel[];\n\n  // The duplication is necessary for TypeScript\n  // tslint:disable-next-line:unified-signatures\n  constructor(...statesToKeep: StateClass[]);\n  constructor();\n  constructor(...statesToKeep: StateClass[]) {\n    const reducer = createMetaDataListReducer(isDevMode());\n    this.statesToKeep = statesToKeep.reduce<MetaDataModel[]>(reducer, []);\n  }\n}\n\n/**\n * Action to overwrite state(s) with given value(s)\n */\nexport class StateOverwrite {\n  static readonly type = '@@OVERWRITE_STATE';\n  public readonly statesToOverwrite: MetaDataModel[];\n  public readonly values: any[];\n  constructor(...overwriteConfigs: OverwriteTuple[]) {\n    const reducer = createMetaTupleReducer(isDevMode());\n    const [states, values] = overwriteConfigs.reduce<MetaTuple>(reducer, [\n      [],\n      [],\n    ]);\n\n    this.statesToOverwrite = states;\n    this.values = values;\n  }\n}\n\nexport function getMetaData(\n  state: StateClass,\n  devMode: number,\n): MetaDataModel | null {\n  const meta = new Object(getStoreMetadata(state as any)) as MetaDataModel;\n  const isNgxsMeta = meta.name && 'defaults' in meta;\n\n  // Reusability Hack: devMode is number on purpose\n  if (!isNgxsMeta && devMode === -2) {\n    console.warn(`Reset Plugin Warning: ${meta.name} is not a state class.`);\n    return null;\n  }\n\n  return meta;\n}\n\nfunction createMetaDataListReducer(devMode: boolean): MetaListReducer {\n  return (acc: MetaDataModel[], state: StateClass): MetaDataModel[] => {\n    // tslint:disable-next-line:no-bitwise\n    const meta = getMetaData(state, ~devMode);\n\n    return meta ? acc.concat(meta) : acc;\n  };\n}\n\nfunction createMetaTupleReducer(devMode: boolean): MetaTupleReducer {\n  return (acc: MetaTuple, [state, value]: OverwriteTuple): MetaTuple => {\n    // tslint:disable-next-line:no-bitwise\n    const meta = getMetaData(state, ~devMode);\n\n    return meta ? [acc[0].concat(meta), acc[1].concat(value)] : acc;\n  };\n}\n","import { Injectable } from '@angular/core';\nimport { getActionTypeFromInstance, getValue, NgxsPlugin, setValue } from '@ngxs/store';\nimport { MetaDataModel } from './internals';\nimport { ResetService } from './reset.service';\nimport {\n  getMetaData,\n  StateClear,\n  StateOverwrite,\n  StateReset,\n  StateResetAll,\n} from './symbols';\n\n@Injectable()\nexport class NgxsResetPlugin implements NgxsPlugin {\n  constructor(private readonly resetService: ResetService) {}\n\n  private clearStates(state: any, statesToKeep: MetaDataModel[]): any {\n    return statesToKeep\n      .map(meta => getPath(meta))\n      .map(path => ({\n        parts: path.split('.'),\n        value: getValue(state, path),\n      }))\n      .reduce(\n        (obj, { parts, value }) =>\n          parts.reduceRight(\n            (acc, part) =>\n              part in obj\n                ? {\n                    [part]: {\n                      ...obj[part],\n                      ...acc,\n                    },\n                  }\n                : { [part]: acc },\n            value,\n          ),\n        {} as any,\n      );\n  }\n\n  private overwriteStates(\n    state: any,\n    statesToOverwrite: MetaDataModel[],\n    values: any[],\n  ): any {\n    statesToOverwrite.forEach(\n      (meta, index) => (state = setValue(state, getPath(meta), values[index])),\n    );\n    return state;\n  }\n\n  private resetStates(state: any, statesToReset: MetaDataModel[]): any {\n    statesToReset.forEach(meta => {\n      state = setValue(\n        state,\n        getPath(meta),\n        typeof meta.defaults === 'undefined' ? {} : meta.defaults,\n      );\n\n      if (meta.children) {\n        state = this.resetStates(state, meta.children.map(\n          getMetaData,\n        ) as MetaDataModel[]);\n      }\n    });\n\n    return state;\n  }\n\n  private resetStatesAll(state: any, statesToKeep: MetaDataModel[]): any {\n    const values = statesToKeep.map(meta => getValue(state, getPath(meta)));\n\n    return this.overwriteStates(this.resetService.initialState, statesToKeep, values);\n  }\n\n  handle(state: any, action: any, next: any) {\n    const type = getActionTypeFromInstance(action);\n\n    switch (type) {\n      case StateClear.type:\n        state = this.clearStates(state, (action as StateClear).statesToKeep);\n        break;\n\n      case StateReset.type:\n        state = this.resetStates(state, (action as StateReset).statesToReset);\n        break;\n\n      case StateResetAll.type:\n        state = this.resetStatesAll(state, (action as StateResetAll).statesToKeep);\n        break;\n\n      case StateOverwrite.type:\n        const { statesToOverwrite, values } = action as StateOverwrite;\n        state = this.overwriteStates(state, statesToOverwrite, values);\n        break;\n\n      default:\n        break;\n    }\n\n    return next(state, action);\n  }\n}\n\nfunction getPath(meta: MetaDataModel): string {\n  return meta.path;\n}\n","import { APP_INITIALIZER, ModuleWithProviders, NgModule } from '@angular/core';\nimport { NGXS_PLUGINS } from '@ngxs/store';\nimport { noop } from './internals';\nimport { ResetHandler } from './reset.handler';\nimport { NgxsResetPlugin } from './reset.plugin';\nimport { ResetService } from './reset.service';\n\n@NgModule()\nexport class NgxsResetPluginModule {\n  static forRoot(): ModuleWithProviders<NgxsResetPluginModule> {\n    return {\n      ngModule: NgxsResetPluginModule,\n      providers: [\n        ResetService,\n        ResetHandler,\n        {\n          provide: APP_INITIALIZER,\n          useFactory: noop,\n          deps: [ResetHandler],\n          multi: true,\n        },\n        {\n          provide: NGXS_PLUGINS,\n          useClass: NgxsResetPlugin,\n          multi: true,\n        },\n      ],\n    };\n  }\n}\n"],"names":[],"mappings":"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"}